<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Root Word Game</title>
    <style>
        /* --- VISUAL STYLING START (Mint Green Theme) --- */
        body {
            font-family: 'Helvetica Neue', Helvetica, Arial, sans-serif;
            background-color: #d1e7dd; /* SOFT MINT GREEN BACKGROUND */
            text-align: center;
            padding: 20px;
            display: flex;
            flex-direction: column;
            justify-content: flex-start;
            min-height: 100vh;
            max-width: 600px;
            margin: 0 auto;
        }
        #game-area {
            width: 100%;
            margin-top: 20px;
        }
        h1 { 
            color: #2c3e50;
            font-size: 2.8rem; 
            margin-bottom: 5px; 
            margin-top: 0; 
        }
        .question-text { 
            font-size: 1.3rem; 
            color: #7f8c8d;
            margin-bottom: 30px; 
        }
        
        /* New UI for Meaning/POS */
        .info-box {
            background-color: #ecf0f1;
            padding: 10px;
            border-radius: 8px;
            margin-bottom: 15px;
            font-size: 0.95rem;
            color: #34495e;
            text-align: center;
        }
        .info-box span {
            font-weight: bold;
            color: #2c3e50;
        }
        .info-box p {
            margin: 5px 0;
        }
        .main-word-clickable {
            cursor: pointer;
            text-decoration: underline;
            text-decoration-thickness: 2px;
            text-decoration-color: #3498db;
        }

        /* Progress Bar */
        .progress-container {
            width: 100%;
            background-color: #bdc3c7;
            border-radius: 15px;
            margin-bottom: 20px;
            height: 12px;
        }
        .progress-bar {
            height: 100%;
            background-color: #3498db;
            border-radius: 15px;
            width: 0%;
            transition: width 0.4s ease-out;
        }
        .level-indicator {
            font-size: 1rem;
            color: #2c3e50;
            margin-bottom: 10px;
            text-align: left;
        }

        .btn-container {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        button {
            background-color: white;
            border: 2px solid #3498db;
            color: #2c3e50;
            padding: 16px;
            font-size: 1.3rem;
            border-radius: 25px;
            cursor: pointer;
            transition: all 0.2s;
            font-weight: bold;
            box-shadow: 0 4px 6px rgba(0,0,0,0.15);
            outline: none !important; 
            -webkit-appearance: none; 
        }
        
        button:focus { 
            outline: none !important; 
            box-shadow: 0 2px 4px rgba(0,0,0,0.1); 
        }

        button:hover { 
            background-color: #f5f5f5; 
            border-color: #2c3e50;
        }
        
        button:active { 
            transform: translateY(1px); 
            box-shadow: 0 2px 4px rgba(0,0,0,0.1); 
            background-color: #ecf0f1; 
        }
        
        /* Feedback Styles */
        .correct { 
            background-color: #d4f8e5 !important; 
            border-color: #2ecc71 !important;
            color: #2ecc71 !important; 
        }
        .wrong { 
            background-color: #fbecec !important; 
            border-color: #e74c3c !important;
            color: #e74c3c !important; 
            animation: shake 0.5s;
        }

        @keyframes shake {
            0% { transform: translateX(0); }
            25% { transform: translateX(-4px); }
            50% { transform: translateX(4px); }
            75% { transform: translateX(-4px); }
            100% { transform: translateX(0); }
        }

        .jp-sub {
            display: block;
            font-size: 0.8rem;
            font-weight: normal;
            color: #95a5a6;
            margin-top: 4px;
        }

        .reset-link {
            margin-top: 30px;
            color: #95a5a6;
            text-decoration: underline;
            font-size: 0.9rem;
            cursor: pointer;
            transition: color 0.2s;
        }
        .reset-link:hover {
            color: #2c3e50;
        }

        /* Example Sentence Box */
        .example-box {
            background-color: #f0f8ff; /* Light Blue/White */
            border: 2px solid #3498db;
            padding: 15px;
            border-radius: 10px;
            margin-top: 20px;
            font-size: 1.1rem;
            color: #2c3e50;
            font-weight: bold;
            text-align: left;
        }
        .example-box span {
            font-weight: normal;
            color: #7f8c8d;
            display: block;
            margin-top: 5px;
            font-size: 0.9rem;
        }

        /* Report Card Styles */
        .report-card {
            background: white;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.1);
        }
        .score-header {
            font-size: 1.8rem;
            color: #2c3e50;
            margin-bottom: 20px;
            font-weight: bold;
        }
        .score-breakdown {
            text-align: left;
            margin-bottom: 25px;
            background-color: #ecf0f1;
            padding: 15px;
            border-radius: 10px;
        }
        .stat-row {
            display: flex;
            justify-content: space-between;
            margin: 10px 0;
            font-size: 1.1rem;
            color: #2c3e50;
            border-bottom: 1px solid #dcdcdc;
            padding-bottom: 5px;
        }
        .total-score {
            font-size: 3rem;
            color: #2ecc71;
            font-weight: bold;
            margin-top: 15px;
        }

        /* Explanation Styling */
        .explanation-box {
            background-color: #ecf0f1;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            text-align: left;
            font-size: 0.95rem;
            color: #34495e;
            line-height: 1.4;
        }
        .explanation-box h3 {
            color: #2c3e50;
            margin-top: 0;
            border-bottom: 2px solid #bdc3c7;
            padding-bottom: 5px;
            font-size: 1.2rem;
        }
        .explanation-box ul {
            padding-left: 20px;
        }
        .japanese-text {
            font-size: 0.9rem;
            color: #7f8c8d;
            border-top: 1px dashed #bdc3c7;
            padding-top: 10px;
            margin-top: 10px;
        }
        /* --- VISUAL STYLING END --- */
    </style>
</head>
<body>

    <div id="game-area">
        </div>

<script>
    // --- GLOBAL CONSTANTS ---
    const SECTION_SIZE = 5; // CHECKPOINT EVERY 5 WORDS
    const START_POS_AT_LEVEL = 10; // START POS PHASE AFTER 10 WORDS (2 SECTIONS)
    
    // --- THE DATA STRUCTURE (Updated with simpleExample) ---
    const levels = [
        // *** SECTION 1: CORE VOCABULARY (Root Only for beginners) ***
        { display: "Creative", root: "Create", decoys: ["Creation", "Crate"], pos: "Verb", derivativePos: "Adjective", jpMeaning: "ÂâµÈÄ†ÁöÑ„Å™ (S≈çz≈ç-teki na)", jpPos: "ÂΩ¢ÂÆπË©û", simpleExample: "I like to create things." },
        { display: "Excited", root: "Excite", decoys: ["Exci", "Cited"], pos: "Verb", derivativePos: "Adjective", jpMeaning: "„Çè„Åè„Çè„Åè„Åó„Åü (Wakuwaku shita)", jpPos: "ÂΩ¢ÂÆπË©û", simpleExample: "The news will excite the crowd." },
        { display: "Thirsty", root: "Thirst", decoys: ["Thirs", "Hersty"], pos: "Noun", derivativePos: "Adjective", jpMeaning: "Âñâ„ÅåÊ∏á„ÅÑ„Åü (Nodo ga kawaita)", jpPos: "ÂΩ¢ÂÆπË©û", simpleExample: "Running gives me thirst." },
        { display: "Bored", root: "Bore", decoys: ["Bo", "Ord"], pos: "Verb", derivativePos: "Adjective", jpMeaning: "ÈÄÄÂ±à„Åó„Åü (Taikutsu shita)", jpPos: "ÂΩ¢ÂÆπË©û", simpleExample: "This movie will bore me." },
        { display: "Confused", root: "Confuse", decoys: ["Confu", "Fused"], pos: "Verb", derivativePos: "Adjective", jpMeaning: "Ê∑∑‰π±„Åó„Åü (Konran shita)", jpPos: "ÂΩ¢ÂÆπË©û", simpleExample: "The map will confuse him." },
        
        // *** SECTION 2: CORE VOCABULARY (Root Only Continued) ***
        { display: "Scared", root: "Scare", decoys: ["Sca", "Aird"], pos: "Verb", derivativePos: "Adjective", jpMeaning: "ÊÄñ„Åå„Å£„Åü (Kowagatta)", jpPos: "ÂΩ¢ÂÆπË©û", simpleExample: "Ghosts scare me easily." },
        { display: "Nervous", root: "Nerve", decoys: ["Nerva", "Ous"], pos: "Noun", derivativePos: "Adjective", jpMeaning: "Á∑äÂºµ„Åó„Åü (Kinch≈ç shita)", jpPos: "ÂΩ¢ÂÆπË©û", simpleExample: "She has a lot of nerve." },
        { display: "Careful", root: "Care", decoys: ["Cay", "Are"], pos: "Verb", derivativePos: "Adjective", jpMeaning: "Ê≥®ÊÑèÊ∑±„ÅÑ (Ch≈´i-bukai)", jpPos: "ÂΩ¢ÂÆπË©û", simpleExample: "I care about my health." },
        { display: "Friendly", root: "Friend", decoys: ["Frie", "End"], pos: "Noun", derivativePos: "Adjective", jpMeaning: "Ë¶™„Åó„Åø„ÇÑ„Åô„ÅÑ (Shitamiyasui)", jpPos: "ÂΩ¢ÂÆπË©û", simpleExample: "He is my best friend." },
        { display: "Beautiful", root: "Beauty", decoys: ["Beaut", "Be"], pos: "Noun", derivativePos: "Adjective", jpMeaning: "Áæé„Åó„ÅÑ (Utsukushii)", jpPos: "ÂΩ¢ÂÆπË©û", simpleExample: "The flowers have great beauty." },
        
        // *** SECTION 3: COMMON AFFIXES (Root + POS Starts Here) ***
        { display: "Dishonesty", root: "Honest", decoys: ["Dishon", "Esty"], pos: "Adjective", derivativePos: "Noun", jpMeaning: "‰∏çÊ≠£Áõ¥ (Fush≈çjiki)", jpPos: "ÂêçË©û", simpleExample: "We must be honest with each other." },
        { display: "Improvement", root: "Improve", decoys: ["Impro", "Ment"], pos: "Verb", derivativePos: "Noun", jpMeaning: "ÊîπÂñÑ (Kaizen)", jpPos: "ÂêçË©û", simpleExample: "We need to improve the system." },
        { display: "Invisibility", root: "Visible", decoys: ["Invisib", "Lity"], pos: "Adjective", derivativePos: "Noun", jpMeaning: "‰∏çÂèØË¶ñÊÄß (Fukashisei)", jpPos: "ÂêçË©û", simpleExample: "The moon is not always visible." },
        { display: "Decision", root: "Decide", decoys: ["Decis", "Cision"], pos: "Verb", derivativePos: "Noun", jpMeaning: "Ê±∫ÂÆö (Kettei)", jpPos: "ÂêçË©û", simpleExample: "I need to decide quickly." },
        { display: "Happiness", root: "Happy", decoys: ["Happ", "Iness"], pos: "Adjective", derivativePos: "Noun", jpMeaning: "Âπ∏Á¶è (K≈çfuku)", jpPos: "ÂêçË©û", simpleExample: "I am happy today." },
        
        // *** SECTION 4: COMMON AFFIXES (Continued) ***
        { display: "Disagreement", root: "Agree", decoys: ["Disagreem", "Dis"], pos: "Verb", derivativePos: "Noun", jpMeaning: "ÊÑèË¶ã„ÅÆ‰∏ç‰∏ÄËá¥ (Iken no fuitchi)", jpPos: "ÂêçË©û", simpleExample: "Do you agree with my plan?" },
        { display: "Creator", root: "Create", decoys: ["Creat", "Or"], pos: "Verb", derivativePos: "Noun", jpMeaning: "ÂâµÈÄ†‰∏ª (S≈çz≈çshu)", jpPos: "ÂêçË©û", simpleExample: "I will create a new picture." },
        { display: "Complicated", root: "Complicate", decoys: ["Compli", "Cated"], pos: "Verb", derivativePos: "Adjective", jpMeaning: "Ë§áÈõë„Å™ (Fukuzatsu na)", jpPos: "ÂΩ¢ÂÆπË©û", simpleExample: "Do not complicate the instructions." },
        { display: "Closed", root: "Close", decoys: ["Clo", "Osed"], pos: "Verb", derivativePos: "Adjective", jpMeaning: "ÈñâÈéñ„Åï„Çå„Åü (Heisa sareta)", jpPos: "ÂΩ¢ÂÆπË©û", simpleExample: "Please close the door quietly." },
        { display: "Dangerous", root: "Danger", decoys: ["Dange", "Gerous"], pos: "Noun", derivativePos: "Adjective", jpMeaning: "Âç±Èô∫„Å™ (Kiken na)", jpPos: "ÂΩ¢ÂÆπË©û", simpleExample: "Be careful of the danger." },

        // *** SECTION 5: COMPLEX VOCABULARY ***
        { display: "Healthy", root: "Health", decoys: ["Hell", "Elthy"], pos: "Noun", derivativePos: "Adjective", jpMeaning: "ÂÅ•Â∫∑ÁöÑ„Å™ (Kenk≈ç-teki na)", jpPos: "ÂΩ¢ÂÆπË©û", simpleExample: "He has good health." },
        { display: "Disgusting", root: "Disgust", decoys: ["Dis", "Gust"], pos: "Verb", derivativePos: "Adjective", jpMeaning: "„ÅÜ„Çì„Åñ„Çä„Åô„Çã„Çà„ÅÜ„Å™ (Unzari suru y≈ç na)", jpPos: "ÂΩ¢ÂÆπË©û", simpleExample: "The smell will disgust him." },
        { display: "Interesting", root: "Interest", decoys: ["Inter", "Esting"], pos: "Verb", derivativePos: "Adjective", jpMeaning: "ËààÂë≥Ê∑±„ÅÑ (Ky≈çmi-bukai)", jpPos: "ÂΩ¢ÂÆπË©û", simpleExample: "This book will interest me." },
        { display: "Boring", root: "Bore", decoys: ["Bo", "Ring"], pos: "Verb", derivativePos: "Adjective", jpMeaning: "„Å§„Åæ„Çâ„Å™„ÅÑ (Tsumaranai)", jpPos: "ÂΩ¢ÂÆπË©û", simpleExample: "I hope you do not bore us." },
        { display: "Funny", root: "Fun", decoys: ["Fu", "Unny"], pos: "Noun", derivativePos: "Adjective", jpMeaning: "„Åä„Åã„Åó„ÅÑ (Okashii)", jpPos: "ÂΩ¢ÂÆπË©û", simpleExample: "We had a lot of fun at the party." },
        
        // *** SECTION 6: COMPLEX VOCABULARY (Continued) ***
        { display: "Annoying", root: "Annoy", decoys: ["Anno", "Oying"], pos: "Verb", derivativePos: "Adjective", jpMeaning: "Ëø∑ÊÉë„Å™ (Meiwaku na)", jpPos: "ÂΩ¢ÂÆπË©û", simpleExample: "That sound will annoy the neighbors." },
        { display: "Messy", root: "Mess", decoys: ["Me", "Essy"], pos: "Noun", derivativePos: "Adjective", jpMeaning: "Êï£„Çâ„Åã„Å£„Åü (Chirakatta)", jpPos: "ÂΩ¢ÂÆπË©û", simpleExample: "Please clean up the mess." },
        { display: "Expensive", root: "Expense", decoys: ["Expe", "Sive"], pos: "Noun", derivativePos: "Adjective", jpMeaning: "È´ò‰æ°„Å™ (K≈çka na)", jpPos: "ÂΩ¢ÂÆπË©û", simpleExample: "The cost is a large expense." },
        { display: "Valuable", root: "Value", decoys: ["Val", "Able"], pos: "Verb", derivativePos: "Adjective", jpMeaning: "Ë≤¥Èáç„Å™ (Kich≈ç na)", jpPos: "ÂΩ¢ÂÆπË©û", simpleExample: "I value your time." },
        { display: "Worthless", root: "Worth", decoys: ["Wore", "Less"], pos: "Noun", derivativePos: "Adjective", jpMeaning: "‰æ°ÂÄ§„ÅÆ„Å™„ÅÑ (Kachi no nai)", jpPos: "ÂΩ¢ÂÆπË©û", simpleExample: "I know the worth of this gold." },

        // *** SECTION 7: OPPOSITES/NEGATIVES ***
        { display: "Famous", root: "Fame", decoys: ["Fama", "Mous"], pos: "Noun", derivativePos: "Adjective", jpMeaning: "ÊúâÂêç„Å™ (Y≈´mei na)", jpPos: "ÂΩ¢ÂÆπË©û", simpleExample: "The singer found great fame." },
        { display: "Unknown", root: "Know", decoys: ["No", "Own"], pos: "Verb", derivativePos: "Adjective", jpMeaning: "Êú™Áü•„ÅÆ (Michi no)", jpPos: "ÂΩ¢ÂÆπË©û", simpleExample: "I know the answer." },
        { display: "Different", root: "Differ", decoys: ["Diff", "Erent"], pos: "Verb", derivativePos: "Adjective", jpMeaning: "Áï∞„Å™„Çã (Kotonaru)", jpPos: "ÂΩ¢ÂÆπË©û", simpleExample: "We often differ in opinion." },
        { display: "Opposite", root: "Oppose", decoys: ["Oppo", "Site"], pos: "Verb", derivativePos: "Adjective", jpMeaning: "ÂèçÂØæ„ÅÆ (Hantai no)", jpPos: "ÂΩ¢ÂÆπË©û", simpleExample: "I oppose that idea." },
        { display: "Unnecessary", root: "Necessary", decoys: ["Uness", "Sary"], pos: "Adjective", derivativePos: "Adjective", jpMeaning: "‰∏çÂøÖË¶Å„Å™ (Fuhitsuy≈ç na)", jpPos: "ÂΩ¢ÂÆπË©û", simpleExample: "Sleep is necessary for health." },
        
        // *** SECTION 8: OPPOSITES/NEGATIVES (Continued) ***
        { display: "Impossible", root: "Possible", decoys: ["Imposs", "Sible"], pos: "Adjective", derivativePos: "Adjective", jpMeaning: "‰∏çÂèØËÉΩ„Å™ (Fukan≈ç na)", jpPos: "ÂΩ¢ÂÆπË©û", simpleExample: "It is possible to win the game." },
        { display: "Incorrect", root: "Correct", decoys: ["Incor", "Rect"], pos: "Adjective", derivativePos: "Adjective", jpMeaning: "ÈñìÈÅï„Å£„Åü (Machigatta)", jpPos: "ÂΩ¢ÂÆπË©û", simpleExample: "Please correct my mistake." },
        { display: "Unfair", root: "Fair", decoys: ["Unfai", "Air"], pos: "Adjective", derivativePos: "Adjective", jpMeaning: "‰∏çÂÖ¨Âπ≥„Å™ (Fuk≈çhei na)", jpPos: "ÂΩ¢ÂÆπË©û", simpleExample: "The rules must be fair." },
        { display: "Dishonest", root: "Honest", decoys: ["Dishon", "Nest"], pos: "Adjective", derivativePos: "Adjective", jpMeaning: "‰∏çÊ≠£Áõ¥„Å™ (Fush≈çjiki na)", jpPos: "ÂΩ¢ÂÆπË©û", simpleExample: "She is always honest." }
    ];

    // Global State Variables
    let currentLevelIndex = 0;
    let rootMistakes = 0;
    let posMistakes = 0;
    let startOfSectionRootMistakes = 0;
    let startOfSectionPosMistakes = 0;
    // New variable to track attempts per phase (for reward system feedback)
    let currentRootAttempts = 0;
    let currentPosAttempts = 0;

    let mainWordEl, instructionEl, buttonsEl, progressBar, levelIndicator, gameArea, exampleBox;
    gameArea = document.getElementById('game-area');

    // --- INITIAL HOME PAGE RENDER (Updated instruction for new phases) ---
    function renderHomePage() {
        gameArea.innerHTML = `
            <h1>Root Word Game</h1>
            <div class="explanation-box">
                
                <h3>The Science Behind the Game üß†</h3>
                <p>
                    „Åì„ÅÆ„Ç≤„Éº„É†„ÅØ„ÄÅËã±ÂçòË™û„ÅÆ**Ë™ûÊ†πÔºàRoot WordÔºâ**„Å®**ÂìÅË©ûÔºàPart of SpeechÔºâ**„ÅÆË≠òÂà•„Çí„ÄÅËÑ≥„ÅÆ**ÊΩúÂú®„Éç„ÉÉ„Éà„ÉØ„Éº„ÇØ**„Å´ÁµÑ„ÅøËæº„ÇÄ„Åü„ÇÅ„Å´Ë®≠Ë®à„Åï„Çå„Å¶„ÅÑ„Åæ„Åô„ÄÇÈ´òÈÄü„ÅßÁõ¥ÊÑüÁöÑ„Å™„Çø„Çπ„ÇØ„Å´ÈõÜ‰∏≠„Åô„Çã„Åì„Å®„Åß„ÄÅ‰ºöË©±‰∏≠„ÅÆ**Ë®àÁÆóË≤†Ëç∑„ÇíËªΩÊ∏õ**„Åó„Åæ„Åô„ÄÇ
                </p>
                <hr style="border-top: 1px dashed #bdc3c7; margin: 15px 0;">
                
                <h3>How to Play / ÈÅä„Å≥Êñπ</h3>
                <ul>
                    <li>**BEGINNER PHASE (Words 1-10):** Focus only on the **Root Word** to build confidence and flow.</li>
                    <li>**ADVANCED PHASE (Words 11+):** Adds the **Part of Speech (POS)** challenge.</li>
                    <li>**Sections:** The game features quick sections of **5 words** each.</li>
                    <li>**Tip:** Click the main word to hear it again. / „É°„Ç§„É≥„ÅÆÂçòË™û„Çí„ÇØ„É™„ÉÉ„ÇØ„Åô„Çã„Å®„ÄÅ„ÇÇ„ÅÜ‰∏ÄÂ∫¶ËÅû„Åè„Åì„Å®„Åå„Åß„Åç„Åæ„Åô„ÄÇ</li>
                </ul>
            </div>
            <div class="btn-container">
                <button onclick="initGame()">START GAME / „Ç≤„Éº„É†ÈñãÂßã</button>
            </div>
            <div class="reset-link" onclick="resetProgress()">Reset Progress (Start Over) / ÈÄ≤Êçó„Çí„É™„Çª„ÉÉ„Éà</div>
        `;
    }

    // --- SIMPLE VOICE ENGINE (Rate kept low at 0.6) ---
    let selectedVoice = null;

    function getEnglishVoice() {
        if (selectedVoice) return selectedVoice;
        
        const voices = window.speechSynthesis.getVoices();
        
        selectedVoice = voices.find(voice => 
            voice.lang === 'en-US' && voice.name.includes('Google') || 
            voice.lang === 'en-US' && voice.name.includes('Samantha') ||
            voice.lang === 'en-GB' && voice.name.includes('Google') ||
            voice.lang === 'en-US'
        );
        
        if (!selectedVoice) {
            selectedVoice = voices.find(voice => voice.lang === 'en-US');
        }
        
        return selectedVoice;
    }

    function speak(text) {
        window.speechSynthesis.cancel();
        
        if (window.speechSynthesis.getVoices().length === 0) {
            window.speechSynthesis.onvoiceschanged = () => {
                const voice = getEnglishVoice();
                if (voice) {
                    const utterance = new SpeechSynthesisUtterance(text);
                    utterance.voice = voice;
                    utterance.rate = 0.6;
                    utterance.lang = "en-US";
                    window.speechSynthesis.speak(utterance);
                }
            };
            return;
        }

        const voice = getEnglishVoice();
        
        if (voice) {
            const utterance = new SpeechSynthesisUtterance(text);
            utterance.voice = voice;
            utterance.rate = 0.6;
            utterance.lang = "en-US";
            window.speechSynthesis.speak(utterance);
        } else {
            const utterance = new SpeechSynthesisUtterance(text);
            utterance.rate = 0.6;
            utterance.lang = "en-US"; 
            window.speechSynthesis.speak(utterance);
        }
    }


    // --- SAVE & PROGRESS FUNCTIONS (Updated SECTION_SIZE in UI) ---
    function initGame() {
        const savedIndex = localStorage.getItem('wordGameProgress');
        const savedRootMistakes = localStorage.getItem('wordGameRootMistakes');
        const savedPosMistakes = localStorage.getItem('wordGamePosMistakes');
        
        if (savedIndex) {
            currentLevelIndex = parseInt(savedIndex);
            if (currentLevelIndex >= levels.length) currentLevelIndex = 0;
        } else {
            currentLevelIndex = 0;
        }

        if (savedRootMistakes) rootMistakes = parseInt(savedRootMistakes);
        else rootMistakes = 0;

        if (savedPosMistakes) posMistakes = parseInt(savedPosMistakes);
        else posMistakes = 0;
        
        startOfSectionRootMistakes = rootMistakes;
        startOfSectionPosMistakes = posMistakes;

        loadLevel(currentLevelIndex);
    }

    function saveProgress() {
        localStorage.setItem('wordGameProgress', currentLevelIndex);
        localStorage.setItem('wordGameRootMistakes', rootMistakes);
        localStorage.setItem('wordGamePosMistakes', posMistakes);
    }

    function resetProgress() {
        if(confirm("Start from the beginning? / ÊúÄÂàù„Åã„Çâ„ÇÑ„ÇäÁõ¥„Åó„Åæ„Åô„ÅãÔºü")) {
            localStorage.removeItem('wordGameProgress');
            localStorage.removeItem('wordGameRootMistakes');
            localStorage.removeItem('wordGamePosMistakes');
            currentLevelIndex = 0;
            rootMistakes = 0;
            posMistakes = 0;
            startOfSectionRootMistakes = 0;
            startOfSectionPosMistakes = 0;
            renderHomePage(); 
        }
    }

    function updateProgressUI() {
        progressBar = document.getElementById('progress-bar');
        levelIndicator = document.getElementById('level-indicator');

        const totalSections = Math.ceil(levels.length / SECTION_SIZE);
        const currentSection = Math.floor(currentLevelIndex / SECTION_SIZE) + 1;
        const wordInCurrentSection = (currentLevelIndex % SECTION_SIZE) + 1;
        const wordsInSection = (currentSection < totalSections) ? SECTION_SIZE : levels.length % SECTION_SIZE;
        
        const percentage = (currentLevelIndex / levels.length) * 100;
        progressBar.style.width = percentage + "%";
        
        levelIndicator.innerHTML = `
            Section ${currentSection} of ${totalSections} 
            | Word ${wordInCurrentSection} of ${wordsInSection || SECTION_SIZE}
        `;
    }

    function handleNextLevelTransition(data) {
        currentLevelIndex++;
        saveProgress(); 
        
        // CHECKPOINT LOGIC (Every 5 words)
        if (currentLevelIndex < levels.length && (currentLevelIndex % SECTION_SIZE === 0)) {
            showCheckpoint();
        } else {
            loadLevel(currentLevelIndex);
        }
    }
    
    // --- CHECKPOINT SCREEN & FINAL REPORT (No changes needed) ---
    function showCheckpoint() {
        const sectionNum = Math.floor(currentLevelIndex / SECTION_SIZE);
        const nextSection = sectionNum + 1;
        
        // CALCULATE SECTIONAL SCORES
        const sectionRootMistakes = rootMistakes - startOfSectionRootMistakes;
        const sectionPosMistakes = posMistakes - startOfSectionPosMistakes;

        const wordsInThisSection = (sectionNum * SECTION_SIZE < levels.length) ? SECTION_SIZE : levels.length % SECTION_SIZE;
        
        // Total tasks is 10 for advanced, 5 for beginner (if current level index is <= 10)
        const totalSectionTasks = (currentLevelIndex > START_POS_AT_LEVEL) ? wordsInThisSection * 2 : wordsInThisSection; 
        const mistakesInSection = (currentLevelIndex > START_POS_AT_LEVEL) ? (sectionRootMistakes + sectionPosMistakes) : sectionRootMistakes;

        const totalCorrect = totalSectionTasks - mistakesInSection;
        
        const sectionAccuracy = Math.round((totalCorrect / totalSectionTasks) * 100);
        
        gameArea.innerHTML = `
            <div class="report-card">
                <div class="score-header" style="color:#3498db;">Checkpoint Complete!</div>
                <h1 style="font-size: 2rem; margin-top:10px;">Section ${sectionNum} Results</h1>
                
                <div class="score-breakdown" style="padding: 20px;">
                    <div class="stat-row">
                        <span><strong>Root Word Score:</strong></span> 
                        <span style="color: ${sectionRootMistakes === 0 ? '#2ecc71' : '#e74c3c'}">
                            ${wordsInThisSection - sectionRootMistakes}/${wordsInThisSection}
                        </span>
                    </div>
                    ${currentLevelIndex > START_POS_AT_LEVEL ? `
                    <div class="stat-row">
                        <span><strong>Part of Speech Score:</strong></span> 
                        <span style="color: ${sectionPosMistakes === 0 ? '#2ecc71' : '#e74c3c'}">
                            ${wordsInThisSection - sectionPosMistakes}/${wordsInThisSection}
                        </span>
                    </div>` : ''}
                    <hr style="margin: 10px 0; border-top: 1px solid #ccc;">
                    <div class="stat-row" style="font-weight: bold; font-size: 1.2rem;">
                        <span>Section Accuracy:</span> 
                        <span style="color: #2c3e50;">${sectionAccuracy}%</span>
                    </div>
                </div>

                <p style="color: #777; margin-top:20px;">
                    Ready for Section ${nextSection}?
                </p>
                <button onclick="loadLevel(${currentLevelIndex})" style="margin-top:20px;">
                    Continue to Section ${nextSection}
                </button>
            </div>
        `;

        // UPDATE START OF SECTION MISTAKE TRACKERS FOR THE NEXT SECTION
        startOfSectionRootMistakes = rootMistakes;
        startOfSectionPosMistakes = posMistakes;
    }

    function showReportCard() {
        const totalWords = levels.length;
        const totalAttempts = (totalWords * 2) + rootMistakes + posMistakes;
        const totalCorrectActions = totalWords * 2;
        
        const overallAccuracy = Math.round((totalCorrectActions / totalAttempts) * 100);

        // Scoring based on Successes / Total
        const rootSuccesses = totalWords - rootMistakes;
        const posSuccesses = totalWords - posMistakes;

        // Rating Logic
        let rating = "Good Effort";
        if (overallAccuracy === 100) rating = "Perfect Score!";
        else if (overallAccuracy >= 90) rating = "Master!";
        else if (overallAccuracy >= 80) rating = "Great Job";

        gameArea.innerHTML = `
            <div class="report-card">
                <div class="score-header">Course Complete</div>
                
                <div class="score-breakdown">
                    <div class="stat-row">
                        <span><strong>Root Word Score:</strong></span> 
                        <span style="color: ${rootMistakes === 0 ? '#2ecc71' : '#e74c3c'}">
                            ${rootSuccesses}/${totalWords}
                        </span>
                    </div>
                    <div class="stat-row">
                        <span><strong>Grammar Score:</strong></span> 
                        <span style="color: ${posMistakes === 0 ? '#2ecc71' : '#e74c3c'}">
                            ${posSuccesses}/${totalWords}
                        </span>
                    </div>
                </div>
                
                <div style="margin-top:20px;">Overall Accuracy</div>
                <div class="total-score">${overallAccuracy}%</div>
                <div style="color:#888; margin-bottom:20px;">${rating}</div>

                <p style="color: #777; font-size: 0.9rem;">Take a screenshot for your teacher!</p>
                <button onclick="resetProgress()" style="margin-top:20px;">Play Again</button>
            </div>
        `;
    }

    // --- NEW FUNCTION: Show Example Sentence and Load Next Word ---
    function showExampleAndNext(data) {
        // Clear buttons and instruction
        buttonsEl.innerHTML = '';
        instructionEl.innerText = "Example Sentence (Êñá„ÅÆ‰æã):";
        
        // Display the sentence
        gameArea.innerHTML += `
            <div class="example-box" id="example-box">
                ${data.simpleExample}
                <span>Tap anywhere to continue...</span>
            </div>
        `;
        exampleBox = document.getElementById('example-box');

        // Speak the root word and example sentence
        speak(`${data.root}. Example. ${data.simpleExample}.`);

        // Wait for user click to proceed (simulates next button)
        exampleBox.onclick = () => {
            handleNextLevelTransition(data);
        };
        // Also listen for a click on the main game area
        gameArea.onclick = (e) => {
            // Prevent interference with the reset link or main elements
            if (e.target.id !== 'reset-link' && e.target.tagName !== 'BUTTON') {
                handleNextLevelTransition(data);
                // Remove the general listener after use
                gameArea.onclick = null; 
            }
        };
    }

    // --- GAME LOGIC ---
    function loadLevel(index) {
        if (index >= levels.length) {
            showReportCard();
            return;
        }

        const data = levels[index];
        const isBeginnerPhase = index < START_POS_AT_LEVEL;

        // Reset attempt counters for the new word
        currentRootAttempts = 0;
        currentPosAttempts = 0;

        // 1. Inject the standard game UI 
        gameArea.innerHTML = `
            <div class="level-indicator" id="level-indicator"></div>
            <div class="progress-container">
                <div class="progress-bar" id="progress-bar"></div>
            </div>
            
            <div class="info-box" id="info-box"></div> 
            
            <h1 id="main-word" class="main-word-clickable"></h1>
            <p class="question-text" id="instruction"></p>
            <div class="btn-container" id="buttons"></div>
            <div class="reset-link" id="reset-link" onclick="resetProgress()">Reset Progress (Start Over)</div>
        `;
        
        // 2. CRITICAL: Re-map the elements
        mainWordEl = document.getElementById('main-word');
        instructionEl = document.getElementById('instruction');
        buttonsEl = document.getElementById('buttons');
        const infoBoxEl = document.getElementById('info-box');

        updateProgressUI();
        
        // --- PHASE 1 START (Root Word) ---
        
        mainWordEl.onclick = () => speak(data.display);
        
        mainWordEl.innerText = data.display;
        
        infoBoxEl.innerHTML = `
            <p>Meaning (ÊÑèÂë≥): <span>${data.jpMeaning}</span></p>
            <p>Part of Speech in English (ÂìÅË©û): <span>${data.derivativePos} (${data.jpPos})</span></p>
        `;

        instructionEl.innerText = "What is the root word?";
        
        speak(data.display);

        // BUTTONS PHASE 1 (Randomize)
        let options = [data.root, ...data.decoys];
        options.sort(() => Math.random() - 0.5);

        buttonsEl.innerHTML = '';
        options.forEach(word => {
            const btn = document.createElement('button');
            btn.innerText = word;
            // Pass the phase state to the click handler
            btn.onclick = () => checkRoot(word, data, btn, infoBoxEl, isBeginnerPhase); 
            buttonsEl.appendChild(btn);
        });
    }

    function checkRoot(selectedWord, data, btnElement, infoBoxEl, isBeginnerPhase) {
        currentRootAttempts++;

        if (selectedWord === data.root) {
            // CORRECT ROOT
            btnElement.classList.add('correct');
            speak(data.root); 
            
            // Check for phase skip (Beginner Mode)
            if (isBeginnerPhase) {
                // Skip POS, show example, and proceed to next word
                setTimeout(() => {
                    showExampleAndNext(data);
                }, 1000); 
            } else {
                // Proceed to POS Phase (Advanced Mode)
                setTimeout(() => {
                    loadPhase2(data, infoBoxEl); 
                }, 1000);
            }
        } else {
            // WRONG ROOT
            btnElement.classList.add('wrong');
            speak("Try again");
            rootMistakes++; 
            saveProgress(); 
        }
    }

    function loadPhase2(data, infoBoxEl) {
        // Clear the Info Box content
        infoBoxEl.innerHTML = ''; 

        // Update UI for Phase 2
        mainWordEl.innerText = data.root;
        mainWordEl.onclick = () => speak(data.root); 
        instructionEl.innerText = `What is the Part of Speech in English for "${data.root}"?`;
        
        buttonsEl.innerHTML = '';

        const posOptions = [
            { en: "Noun", jp: "ÂêçË©û (Meishi)" },
            { en: "Verb", jp: "ÂãïË©û (Doushi)" },
            { en: "Adjective", jp: "ÂΩ¢ÂÆπË©û (Keiyoushi)" }
        ];

        posOptions.forEach(opt => {
            const btn = document.createElement('button');
            btn.innerHTML = `${opt.en} <span class="jp-sub">${opt.jp}</span>`;
            btn.onclick = () => checkPOS(opt.en, data, btn);
            buttonsEl.appendChild(btn);
        });
    }

    function checkPOS(selectedPos, data, btnElement) {
        currentPosAttempts++;
        let isCorrect = (selectedPos === data.pos);

        // Ambiguous Word Fix
        if (data.root === 'Correct' && (selectedPos === 'Adjective' || selectedPos === 'Verb')) {
            isCorrect = true;
        }

        if (isCorrect) {
            // CORRECT POS
            btnElement.classList.add('correct');
            
            // Speak the root and POS
            speak(`${data.root} is a ${selectedPos}`);
            
            // Show example sentence before loading next level
            setTimeout(() => {
                 showExampleAndNext(data);
            }, 2500); 
        } else {
            // WRONG POS
            btnElement.classList.add('wrong');
            speak("Not quite");
            posMistakes++; 
            saveProgress(); 
        }
    }
    
    // Start the page on the home screen
    renderHomePage();

</script>

</body>
</html>
